---
title: "Эффект физической активности в отношении гликированного гемоглобина."
author: "Евгений Бердинских"
date: "`r Sys.Date()`"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo = TRUE,
  fig.path = "data/pics/figure-"
  )

library(tidyverse)
library(conflicted)
library(readxl)
# library(skimr)
# library(rstatix)
# library(ggpubr)
# library(progress)

conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::lag)

theme_custom <- theme_bw()+ theme(
    plot.title = element_text(size = 30, hjust = 0.5),
    plot.subtitle = element_text(size = 25, hjust = 0.5),
    strip.text = element_text(size = 20),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 25),
    legend.title = element_text(size = 25),
    legend.text = element_text(size = 20)
  )

```

## Загрузка данных

```{r read}

data_raw <- read_excel("data/raw/HW_data.xlsx")

```

## Оценка физической активности (+)

Для оценки физической активности респондентов использовались следующие показатели:

-   Часы работы с высокой интенсивностью в неделю (Vigorous Work);
-   Часы работы с умеренной интенсивностью в неделю (Moderate Work);
-   Часы ходьбы или езды на велосипеде в неделю (Walk/Bicycle);
-   Часы занятия спорта с высокой интенсивностью в неделю (Vigorous Sport);
-   Часы занятия спорта с умеренной интенсивностью в неделю (Moderate Sport);

```{r exposure}

data_exposure <- data_raw %>% 
  transmute( 
    VigorousWork = round(PAQ610*PAD615/60,1), 
    ModerateWork = round(PAQ625*PAD630/60,1), 
    WalkBicycle = round(PAQ640*PAD645/60,1), 
    VigorousSport = round(PAQ655*PAD660/60,1), 
    ModerateSport = round(PAQ670*PAD675/60,1)
    ) 

```

Изначально предполагалось, что любые виды физической активности связаны с более низким уровнем гликированного гемоглобина.

## Ковариаты модели  (+)

Для учета эффекта физической активности на уровень гликированного гемоглобина в модель были включены следующие ковариаты, характеризующие респондента:

-   Пол (Sex);
-   Раса (Race): Latino, White, Black, Other;
-   Регулярность курения (Smoking): Every day, Some days, Not at all;
-   Наличие cопутствующих заболеваний: Yes, No
    -   Бронхиальная астма (Asthma)
    -   Болезни сердца (Heart Disease)
    -   Инсульт (Stroke)
    -   Болезни щитовидной железы (Thyroid Disease)
    -   Хронические обструктивные заболевания легких (COPD)
    -   Злокачественные опухоли (Cancer)

```{r covariates}

data_covariates <- data_raw %>% 
  transmute(
    Sex = factor(RIAGENDR, levels = c(1,2), labels = c("Male", "Female")), 
    Race = factor(RIDRETH3, levels = c(1,2,3,4,6,7), labels = c("Latino", "Latino", "White", "Black", "Other", "Other")), 
    Smoking = factor(SMQ040, levels = c(1,2,3), labels = c("Every day", "Some days", "Not at all")), 
    Asthma = factor(ifelse(MCQ010 == 1 | MCQ035 == 1, 1, 2), levels = c(1,2), labels = c("Yes", "No")),
    HeartDisease = factor(ifelse(MCQ160C == 1 | MCQ160B == 1 | MCQ160E == 1, 1, 2), levels = c(1,2), labels = c("Yes", "No")), 
    Stroke = factor(MCQ160F, levels = c(1,2), labels = c("Yes", "No")), 
    ThyroidDisease = factor(ifelse(MCQ160M == 1 | MCQ170M == 1, 1, 2), levels = c(1,2), labels = c("Yes", "No")),
    COPD = factor(MCQ160O, levels = c(1,2), labels = c("Yes", "No")), 
    Cancer = factor(MCQ220, levels = c(1,2), labels = c("Yes", "No"))
    ) 

```

## Задание 2 (бонусное - описание ковариатов)

-   Для представленного DAG'а укажите роль каждого показателя по отношению к изучаемой ассоциации между физической активностью и гликированным гемоглобином (конфаундеры (в том числе proxy конфаундеры), коллайдеры, медиаторы)

## Задание 3

-   Проведите необходимый эксплораторный анализ перед оценкой модели.

## Задание 4

-   Оцените модель для зависимости гликированного гемоглобина от выбранного вами показателя физической активности без ковариат и с ними.
-   Проведите необходимую диагностику этих моделей -- требует ли что-либо коррекции и почему?
-   В случае необходимости коррекции по результатам диагностики сделайте ее.

## Задание 5

-   Представьте результаты оценки модели без ковариат и с ковариатами в виде точечной и интервальной оценки эффекта физической активности. Дайте им словесную интерпретацию.
-   Какие выводы мы можем сделать, исходя из точечной оценки? А из интервальной?
-   Как вы думаете, можно ли считать эффект клинически значимым? Если затрудняетесь с ответом, что бы вам помогло дать ответ на этот вопрос?

## Задание 6

-   Проверьте гипотезу об отсутствии ассоциации между физической активностью и гликиро- ванным гемоглобином.
-   Сделайте выводы по полученным результатам.

## Задание 7

-   Является ли пол модификатором эффекта физической активности в отношении гликированного гемоглобина?
-   Если да, каков эффект для мужчин и женщин и насколько он отличается между ними?

## Задание 8

-   Соответствуют ли полученные вами результаты вашему исходному предположению? Как меняется оценка эффекта физической активности при добавлении ковариат в модель и почему?

## Задание 8 (бонусное)

-   Оцените прямой (direct) эффект физической активности на гликированный гемоглобин (со всей необходимой диагностикой и коррекциями).
-   Как он отличается от общего (total) эффекта? В чем причина/ механизм этих различий?
